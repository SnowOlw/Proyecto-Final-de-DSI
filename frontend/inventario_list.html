<!-- ...existing code... -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Inventario</title>
</head>

<body>
<div class="sidebar">
        <h2>üëï Inventario</h2>
        <a class="menu-btn btn-inventario" href="inventario_list.html">üìã Ver Inventario</a>
        <a class="menu-btn btn-nuevo" href="inventario_form.html">üõçÔ∏è Nuevo Producto</a>
        <a class="menu-btn btn-proveedores" href="proveedores_list.html">üë• Proveedores</a>
        <a class="menu-btn btn-reportes" href="reportes.html">üìë Reportes</a>
    </div>
<header> Inventario</header>

<div class="container">

    <a href="index.html" class="btn">‚¨Ö Volver</a>

    <h2>Listado de Productos</h2>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Producto</th>
                <th>Categor√≠a</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody id="productosBody">
            <!-- Filas cargadas por JS -->
        </tbody>
    </table>

</div>

<!-- ...existing code... -->
<script>
  const API_URL = "http://localhost:1337/api/productos";
  const TOKEN = localStorage.getItem('strapiToken') || null;
  const productosBody = document.getElementById('productosBody');

  function formatMoney(n) {
    return Number(n).toLocaleString('es-NI', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function firstAttr(obj, keys) {
    for (const k of keys) {
      if (obj == null) continue;
      if (Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null) return obj[k];
    }
    return null;
  }

  async function fetchProductos() {
    productosBody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
    try {
      const res = await fetch(`${API_URL}?pagination[pageSize]=100`, {
        headers: { 'Accept': 'application/json' }
      });

      if (!res.ok) {
        const body = await res.json().catch(() => null);
        throw new Error(body?.error?.message || body?.message || `HTTP ${res.status}`);
      }

      const json = await res.json();
      const items = json?.data || [];

      console.log('fetchProductos => raw response:', json);

      if (!items.length) {
        productosBody.innerHTML = '<tr><td colspan="6">No hay productos.</td></tr>';
        return;
      }

      productosBody.innerHTML = items.map(item => {
        // item puede venir como { id, attributes } o como objeto plano
        const id = item?.id ?? item?._id ?? 'N/A';
        const attrs = item?.attributes ?? item ?? {};

        // buscar posibles nombres de campos en la DB
        const nombre = firstAttr(attrs, ['nombre', 'name', 'title', 'producto']) ?? '';
        const categoria = firstAttr(attrs, ['categoria', 'category']) ?? '';
        const cantidad = firstAttr(attrs, ['cantidad', 'stock', 'quantity']) ?? 0;
        const precio = firstAttr(attrs, ['precio', 'price', 'valor']) ?? 0;

        return `
          <tr data-id="${id}">
            <td>${escapeHtml(String(id))}</td>
            <td>${escapeHtml(String(nombre))}</td>
            <td>${escapeHtml(String(categoria))}</td>
            <td>${escapeHtml(String(cantidad))}</td>
            <td>C$ ${formatMoney(precio)}</td>
            <td>
              <a class="btn btn-warning" href="inventario_detail.html?id=${id}">Ver</a>
              <a class="btn btn-success" href="inventario_form.html?id=${id}">Editar</a>
              <button class="btn btn-danger btn-delete" data-id="${id}">Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
    } catch (err) {
      console.error('Error cargando productos:', err);
      productosBody.innerHTML = `
        <tr>
          <td colspan="6">
            Error al cargar productos: ${escapeHtml(String(err.message || err))}
            <div style="margin-top:8px;">
              <button id="retryFetch" class="btn">Reintentar</button>
            </div>
          </td>
        </tr>`;
      const retryBtn = document.getElementById('retryFetch');
      if (retryBtn) retryBtn.addEventListener('click', fetchProductos);
    }
  }

  async function deleteProducto(id, rowEl) {
    if (!confirm('¬øEliminar este producto? Esta acci√≥n no se puede deshacer.')) return;
    try {
      const headers = { 'Accept': 'application/json' };
      if (TOKEN) headers['Authorization'] = `Bearer ${TOKEN}`;

      const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE', headers });
      if (!res.ok) {
        const body = await res.json().catch(() => null);
        throw new Error(body?.error?.message || body?.message || `HTTP ${res.status}`);
      }
      rowEl.remove();
    } catch (err) {
      console.error('Error eliminando producto:', err);
      alert('No se pudo eliminar el producto: ' + (err.message || err));
    }
  }

  productosBody.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-delete');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const row = btn.closest('tr');
    if (!id || !row) return;
    deleteProducto(id, row);
  });

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // Ejecutar carga inicial
  fetchProductos();
</script>
<!-- ...existing code... -->
</body>
</html>
<!-- ...existing code... -->




</body>
</html>
