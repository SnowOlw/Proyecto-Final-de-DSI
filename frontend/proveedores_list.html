<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lista de Proveedores - Los tres Hermanos</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="sidebar">
    <h2>üëï Inventario</h2>
    <a class="menu-btn btn-inventario" href="inventario_list.html">üìã Ver Inventario</a>
    <a class="menu-btn btn-nuevo" href="inventario_form.html">üõçÔ∏è Nuevo Producto</a>
    <a class="menu-btn btn-proveedores" href="proveedores_list.html">üë• Proveedores</a>
    <a class="menu-btn btn-reportes" href="reportes.html">üìë Reportes</a>
  </div>

  <div class="container mt-4">
    <header><h2>Lista de Proveedores</h2></header>
    <a href="index.html" class="btn d-inline-block btn-secondary mt-3 mb-3">Volver al inicio</a>
    <a href="proveedores_form.html" class="btn btn-primary mt-3 mb-3 ms-2">Nuevo Proveedor</a>

    <table class="table table-dark table-striped table-hover mt-2">
      <thead>
        <tr>
          <th>ID</th>
          <th>Proveedor</th>
          <th>Ubicaci√≥n</th>
          <th>Mercader√≠a</th>
          <th>Tel√©fono</th>
          <th>Opciones</th>
        </tr>
      </thead>
      <tbody id="proveedoresBody">
        <tr><td colspan="6">Cargando...</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

<script>
  const API_URL = "http://localhost:1337/api/proveedors";
  const TOKEN = localStorage.getItem('strapiToken') || null;
  const body = document.getElementById('proveedoresBody');

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

  // Buscar primer atributo disponible entre varias opciones
  function firstAttr(obj, keys){
    for(const k of keys){
      if(obj == null) continue;
      if(Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null) return obj[k];
    }
    return '';
  }

  async function fetchProveedores(){
    body.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
    try{
      const res = await fetch(`${API_URL}?pagination[pageSize]=200`, { headers: { 'Accept': 'application/json' } });
      if(!res.ok){
        const err = await res.json().catch(()=>null);
        throw new Error(err?.error?.message || err?.message || `HTTP ${res.status}`);
      }
      const json = await res.json();
      const items = json?.data || [];
      console.log('proveedores raw ->', json);

      if(!items.length){
        body.innerHTML = '<tr><td colspan="6">No hay proveedores.</td></tr>';
        return;
      }

      body.innerHTML = items.map(it => {
        const id = it?.id ?? it?._id ?? 'N/A';
        const attrs = it?.attributes ?? it ?? {};

        // ajustar nombres seg√∫n c√≥mo est√©n en tu collection type
        const nombre = firstAttr(attrs, ['nombre','name','proveedor','empresa','title']);
        const ubicacion = firstAttr(attrs, ['ubicacion','ubicaci√≥n','location','direccion','direccion_fisica']);
        const mercaderia = firstAttr(attrs, ['mercaderia','productos','mercancia','items']);
        const telefono = firstAttr(attrs, ['telefono','tel','phone','telefono_contacto']);

        return `
          <tr data-id="${escapeHtml(id)}">
            <td>${escapeHtml(id)}</td>
            <td>${escapeHtml(nombre)}</td>
            <td>${escapeHtml(ubicacion)}</td>
            <td>${escapeHtml(mercaderia)}</td>
            <td>${escapeHtml(telefono)}</td>
            <td>
              <a class="btn btn-sm btn-warning" href="proveedores_detail.html?id=${id}">Ver</a>
              <a class="btn btn-sm btn-success" href="proveedores_form.html?id=${id}">Editar</a>
              <button class="btn btn-sm btn-danger btn-delete" data-id="${id}">Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
    }catch(err){
      console.error('Error cargando proveedores:', err);
      body.innerHTML = `
        <tr>
          <td colspan="6">
            Error al cargar proveedores: ${escapeHtml(String(err.message||err))}
            <div class="mt-2"><button id="retry" class="btn btn-secondary btn-sm">Reintentar</button></div>
          </td>
        </tr>`;
      const retry = document.getElementById('retry');
      if(retry) retry.addEventListener('click', fetchProveedores);
    }
  }

  async function deleteProveedor(id, row){
    if(!confirm('¬øEliminar este proveedor? Esta acci√≥n no se puede deshacer.')) return;
    try{
      const headers = { 'Accept':'application/json' };
      if(TOKEN) headers['Authorization'] = `Bearer ${TOKEN}`;
      const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE', headers });
      if(!res.ok){
        const err = await res.json().catch(()=>null);
        throw new Error(err?.error?.message || err?.message || `HTTP ${res.status}`);
      }
      row.remove();
    }catch(err){
      console.error('Error eliminando proveedor:', err);
      alert('No se pudo eliminar: ' + (err.message || err));
    }
  }

  // Delegaci√≥n para bot√≥n eliminar
  body.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-delete');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const row = btn.closest('tr');
    if(!id || !row) return;
    deleteProveedor(id, row);
  });

  // Carga inicial
  fetchProveedores();
</script>
</body>
</html>